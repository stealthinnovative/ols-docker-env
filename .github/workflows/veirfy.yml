name: Verify

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  verify:
    name: Verify
    runs-on: ubuntu-latest
    env:
      # Force Compose V2 (uses \`docker compose\`) by default; override if you need docker-compose v1
      COMPOSE_V2: "true"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure Docker Buildx / Compose available
        uses: docker/setup-buildx-action@v3

      - name: Install docker-compose-plugin (if missing)
        run: |
          set -eux
          if ! docker compose version >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y docker-compose-plugin
          fi
          docker --version
          docker compose version

      - name: Prepare .env for CI (do not leak secrets)
        run: |
          cp .env.example .env || true
          # Standardize on MARIADB prefix for CI consistency
          if ! grep -q 'MARIADB_ROOT_PASSWORD' .env; then
            echo "MARIADB_ROOT_PASSWORD=test_ci_pass" >> .env
          fi
          if ! grep -q '^TimeZone=' .env; then
            echo "TimeZone=UTC" >> .env
          fi

      - name: Make verify script executable
        run: |
          chmod +x bin/*.sh || true
          chmod +x .travis/verify.sh || true

      - name: Run verify (legacy + new)
        timeout-minutes: 20
        run: |
          # Use the standardized verification script
          ./.travis/verify.sh all
