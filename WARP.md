# WARP.md

This file provides guidance to WARP (warp.dev) when working with code in this repository.

## Project overview

This repository defines a local/containerized OpenLiteSpeed + WordPress + MariaDB + Redis + phpMyAdmin stack, orchestrated via Docker Compose. Most behavior is driven by:
- `docker-compose.yml` (service graph and networking)
- `.env` (runtime configuration and defaults)
- `bin/*.sh` (host-side management scripts that call into containers)

The typical flow is:
1. Configure base credentials and options in `.env`.
2. Start the stack with `docker compose up`.
3. Use `bin/` scripts to provision domains, databases, WordPress, SSL (ACME or mkcert), and phpMyAdmin.

## Core commands

All commands below are intended to run from the project root.

### Bring up / tear down the stack

- Start stack in foreground (builds images as needed):
  - `docker compose up`
- Start stack in background (recommended for day-to-day dev):
  - `docker compose up -d`
- Stop containers without removing them:
  - `docker compose stop`
- Stop and remove containers:
  - `docker compose down`
- Rebuild custom images (if you add a `custom/Dockerfile` as described in `README.md`) and start:
  - `docker compose up --build`

### Environment configuration

Edit `.env` before first run to control credentials and sizing:
- Base variables:
  - `TIMEZONE`: container timezone.
  - `MYSQL_ROOT_PASSWORD`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`: initial DB root/app credentials.
  - `DOMAIN`: default demo site domain (used by `bin/demosite.sh`).
- Optional capacity tuning:
  - `MARIADB_MAX_CONNS`: uncomment for high-memory setups (e.g., 8GB+).
- Optional image overrides (if you need to pin different tags than the defaults in `docker-compose.yml`):
  - `LITESPEED_IMAGE`, `MARIADB_IMAGE`, `REDIS_IMAGE`.

Do not check real secrets into version control; keep `.env` local.

### CI / verification (sanity test)

GitHub Actions uses `.github/workflows/docker.yml`, which in turn runs `.travis/verify.sh` against a freshly started stack. You can run the same verification flow locally:

- Start the stack in the background:
  - `docker compose up -d`
- Run the verification script:
  - `bash .travis/verify.sh`

This script will:
- Check the OpenLiteSpeed admin UI on `http://localhost:7080/`.
- Verify WordPress is served on `http://localhost/` and `https://localhost/`.
- Verify phpMyAdmin on `http://localhost:8080/`.
- Exercise the domain/database/app install flows using `example.com`.
- Enable and disable OWASP ModSecurity to confirm behavior.

Use this as the closest thing to an integration-test suite when modifying `docker-compose.yml` or `bin/` scripts.

### WebAdmin and server maintenance (`bin/webadmin.sh`)

Key entrypoints:
- Set or change OpenLiteSpeed WebAdmin password:
  - `bash bin/webadmin.sh MY_SECURE_PASS`
- Gracefully restart OpenLiteSpeed:
  - `bash bin/webadmin.sh -r`
- Enable/disable OWASP ModSecurity rules:
  - `bash bin/webadmin.sh --mod-secure enable`
  - `bash bin/webadmin.sh --mod-secure disable`
- Upgrade OpenLiteSpeed to latest stable:
  - `bash bin/webadmin.sh --upgrade`
- Apply a LiteSpeed Enterprise serial:
  - `bash bin/webadmin.sh --serial YOUR_SERIAL`

### Demo WordPress site (`bin/demosite.sh`)

To quickly bootstrap a demo WordPress instance for the domain in `.env` (`DOMAIN`):
- `bash bin/demosite.sh`

This will:
- Ensure a virtual host for `DOMAIN` exists (via `bin/domain.sh`).
- Create a database/user/password using `.env` values (via `bin/database.sh`).
- Install WordPress into that virtual host (via `bin/appinstall.sh`).

### Domain and virtual host management (`bin/domain.sh`)

- Add a domain and create its virtual host + document root under `./sites/<domain>/`:
  - `bash bin/domain.sh --add example.com`
- Remove a domain and corresponding virtual host from the OpenLiteSpeed configuration:
  - `bash bin/domain.sh --del example.com`

After domain operations, `bin/domain.sh` triggers a web server restart through `bin/webadmin.sh -r`.

### Database provisioning (`bin/database.sh`)

`bin/database.sh` talks directly to the `mysql` service via `docker compose exec`.

Common flows:
- Auto-generate DB/user/password for a domain:
  - `bash bin/database.sh --domain example.com`
- Use explicit names instead of autogenerated ones:
  - `bash bin/database.sh --domain example.com --user USER_NAME --password MY_PASS --database DATABASE_NAME`
- Delete a database (and optionally the matching user):
  - `bash bin/database.sh --delete --database examplecom [--user examplecom]`

Credentials are written to `./sites/<domain>/.db_pass` when possible so that other tooling (or humans) can read them.

### WordPress / app installation (`bin/appinstall.sh`)

Install WordPress (or other supported apps defined inside the container’s `appinstallctl.sh`) for an existing domain:
- `bash bin/appinstall.sh --app wordpress --domain example.com`

This script runs `appinstallctl.sh` inside the `litespeed` container and then restarts the web server.

### ACME / Let’s Encrypt certificates (`bin/acme.sh`)

`bin/acme.sh` manages ACME/Let’s Encrypt via a helper script installed inside the `litespeed` container.

Key flows:
- First-time ACME installation with email:
  - `bash bin/acme.sh --install --email you@example.com`
- Request a certificate for a domain (and `www.` variant when reachable):
  - `bash bin/acme.sh --domain example.com`
- Renew a single domain (optionally forcing):
  - `bash bin/acme.sh --domain example.com --renew [--force]`
- Renew all domains:
  - `bash bin/acme.sh --renew-all [--force]`
- Revoke or remove a domain certificate:
  - `bash bin/acme.sh --revoke --domain example.com`
  - `bash bin/acme.sh --remove --domain example.com`

### Local development TLS with mkcert (`bin/mkcert.sh`)

For local-only domains (e.g., `example.test`), `bin/mkcert.sh` integrates mkcert with OpenLiteSpeed:

- Install mkcert and its local CA (one-time per machine):
  - `bash bin/mkcert.sh --install`
- Generate a local certificate for a domain (and `www.` variant) and wire it into OpenLiteSpeed:
  - `bash bin/mkcert.sh --domain example.test`
- Remove a previously configured local certificate and revert to the non-SSL template:
  - `bash bin/mkcert.sh --remove --domain example.test`

Note: `mkcert.sh` expects the domain to already exist as a virtual host (via `bin/domain.sh --add`). It also creates/uses a `docker-local` template inside `lsws/conf` and manages certificates under `/usr/local/lsws/conf/cert/<domain>/` in the container.

### phpMyAdmin integration (`bin/phpmyadmin.sh` + `docker-compose.yml`)

The `phpmyadmin` service in `docker-compose.yml` runs phpMyAdmin under FPM, and `bin/phpmyadmin.sh` wires it into OpenLiteSpeed and exposes it on `http://localhost:8080`.

Typical usage:
- `bash bin/phpmyadmin.sh`

What this script does (high level):
- Loads `.env` from the project root to get MySQL credentials.
- Ensures LSWS vhost configuration directories under `lsws/conf` exist.
- Appends an `externalApp phpmyadmin-fpm` block to `lsws/conf/httpd_config.conf` (if not already present), pointing at the phpMyAdmin FPM Unix socket.
- Creates `lsws/conf/vhosts/phpmyadmin.conf` and a `phpMyAdmin` listener on port 8080.
- Restarts the relevant Docker services: tears down `phpmyadmin`/`litespeed` if needed, then starts `mysql`, `redis`, `phpmyadmin`, and `litespeed`.
- Copies phpMyAdmin application files from the `phpmyadmin` container into `/usr/local/lsws/phpmyadmin` in the `litespeed` container and fixes ownership.
- Restarts OpenLiteSpeed and verifies:
  - FPM socket presence.
  - MySQL connectivity from phpMyAdmin (using `.env` credentials).
  - HTTP availability at `http://localhost:8080`.

When editing `bin/phpmyadmin.sh`, keep it consistent with:
- The `phpmyadmin` service in `docker-compose.yml` (image tag, socket/volume paths, environment).
- Any `externalApp` and vhost references it appends to `lsws/conf/httpd_config.conf`.

### Accessing the database (once phpMyAdmin is up)

After running `bin/phpmyadmin.sh` (or once the stack is healthy per `.travis/verify.sh`), phpMyAdmin should be available at:
- `http://127.0.0.1:8080`

Use the credentials from `.env`:
- `root / MYSQL_ROOT_PASSWORD`
- `MYSQL_USER / MYSQL_PASSWORD`

## High-level architecture

### Service graph (`docker-compose.yml`)

`docker-compose.yml` defines four main services and a shared volume:
- `mysql` (MariaDB):
  - Image: `MARIADB_IMAGE` or `mariadb:lts-noble` by default.
  - Stores data in `./data/db` on the host.
  - Configured via `.env` (`MYSQL_ROOT_PASSWORD`, `MYSQL_DATABASE`, `MYSQL_USER`, `MYSQL_PASSWORD`, and optional `MARIADB_MAX_CONNS`).
  - Exposes no ports directly; other services access it over the default bridge network.
- `litespeed` (OpenLiteSpeed + PHP + WordPress):
  - Image: `litespeedtech/openlitespeed:${LITESPEED_IMAGE}` (default `1.8.5-lsphp85` unless overridden).
  - Mounts host directories:
    - `./lsws/conf` → `/usr/local/lsws/conf` (main server/vhost config).
    - `./lsws/admin-conf` → `/usr/local/lsws/admin/conf` (admin UI config).
    - `./bin/container` → `/usr/local/bin` (container-side helper scripts like `domainctl.sh`, `appinstallctl.sh`, `certhookctl.sh`, `owaspctl.sh`, `serialctl.sh`).
    - `./sites` → `/var/www/vhosts/` (virtual host document roots; WordPress installs here).
    - `./acme` → `/root/.acme.sh/` (ACME config and certs).
    - `./logs` → `/usr/local/lsws/logs/` (web server logs).
    - `phpmyadmin-sockets` volume → `/var/run/phpmyadmin` (for phpMyAdmin FPM socket integration).
  - Ports:
    - `80:80` (HTTP for sites).
    - `443:443` and `443:443/udp` (HTTPS).
    - `7080:7080` (OpenLiteSpeed WebAdmin).
    - `8080:8080` (phpMyAdmin via vhost/listener).
  - Depends on healthy `mysql` and `redis`.
- `phpmyadmin`:
  - Image: `phpmyadmin/phpmyadmin:${PHPMYADMIN_IMAGE:-fpm-alpine}`.
  - Uses `.env` via `env_file: .env`.
  - `PMA_HOST` is set to `mysql:3306` to ensure TCP connectivity.
  - Shares the `phpmyadmin-sockets` volume with `litespeed` so the FPM socket can be addressed from LSWS.
- `redis`:
  - Image: `REDIS_IMAGE` or `redis:alpine`.
  - Stores data under `./redis/data` and configuration in `./redis/redis.conf` on the host.
  - Used by WordPress via LSCache plugin (host name `redis`).

Named volume:
- `phpmyadmin-sockets`: shared between `phpmyadmin` and `litespeed` for Unix-socket-based FPM communication.

All services are attached to the default bridge network.

### Host scripts vs. in-container helpers

A recurring pattern:
- Host scripts in `bin/*.sh` are the user-facing entrypoints.
- They call `docker compose exec` into:
  - `litespeed` for web server config, vhost manipulation, SSL, and app install.
  - `mysql` for DB operations.
- Inside the `litespeed` container, additional helper scripts live under `/usr/local/bin` or LSWS config directories (mounted from `./bin/container`).

When modifying a host script, keep in mind:
- It usually assumes the corresponding container is already running (`docker compose up -d`).
- Many scripts also expect the directory structure under `./sites`, `./lsws`, and `./acme` to be present and writable on the host.

### Data layout on host

As summarized in `README.md`:
- `acme/`: Let’s Encrypt ACME data and issued certs.
- `bin/`: Host-side management scripts; `bin/container/` holds scripts that run inside the `litespeed` container.
- `data/db/`: MariaDB data directory (mounted into `mysql`).
- `logs/`: LSWS and virtual host logs (mounted into `litespeed`).
- `lsws/`: OpenLiteSpeed configuration (`conf/` and `admin-conf/`).
- `sites/`: Document roots for each virtual host; WordPress installs under `sites/<domain>/html`.

## Guidance for future changes

- When editing `docker-compose.yml`, ensure:
  - Volume mounts for `lsws`, `sites`, `acme`, `logs`, `redis`, and `phpmyadmin-sockets` stay consistent with expectations in `bin/` scripts.
  - Service names (`mysql`, `litespeed`, `phpmyadmin`, `redis`) remain stable, as many scripts reference them directly via `docker compose exec`.
- When editing scripts under `bin/`:
  - Preserve their CLI contracts (flags and positional arguments) documented in `README.md` and `.travis/verify.sh`, since external docs and CI depend on them.
  - Be mindful of cross-script coupling: e.g., `demosite.sh` orchestrates `domain.sh`, `database.sh`, and `appinstall.sh`.
  - For `phpmyadmin.sh`, keep behavior aligned with the `phpmyadmin` service definition (PMA_HOST, socket paths, and the `phpmyadmin-sockets` volume).
- Use `.travis/verify.sh` as a regression check whenever you make non-trivial changes to `docker-compose.yml` or the `bin/` scripts.
