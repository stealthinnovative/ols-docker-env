services:
  # --- 1. Database (MariaDB 11.x LTS) ---
  mysql:
    image: ${MARIADB_IMAGE:-mariadb:lts-noble}
    container_name: mariadb
    restart: always
    stop_grace_period: 1m
    # Enables io_uring for Ryzen performance and prevents "Bad magic header" crashes
    security_opt:
      - seccomp:unconfined
    cpuset: "1" 
    sysctls:
      - net.core.somaxconn=65535
    command:
      - "mariadbd"
      - "--thread-cache-size=${THREAD_CACHE_SIZE:-24}"
      - "--max-allowed-packet=${DB_MAX_PACKET:-512M}"
      - "--max-connections=${MARIADB_MAX_CONNS:-151}"
      - "--innodb-buffer-pool-size=${DB_BUFFER_POOL:-512M}"
      - "--innodb-log-file-size=${DB_LOG_FILE:-256M}"
      - "--innodb-flush-log-at-trx-commit=${DB_FLUSH_COMMIT:-2}"
      - "--innodb-read-io-threads=4"
      - "--innodb-write-io-threads=4"
      - "--innodb-io-capacity=20000"
      - "--innodb-io-capacity-max=40000"
      - "--innodb-flush-neighbors=0"
      - "--innodb-data-file-buffering=OFF"
      - "--innodb-log-file-buffering=OFF"
      - "--innodb-flush-method=fsync"
      - "--performance-schema=0"
    deploy:
      resources:
        limits:
          memory: ${DB_MEM_LIMIT:-768M}
    volumes:
      - ./data/db:/var/lib/mysql:delegated
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    networks:
      - wp_network

  # --- 2. Web Server (OpenLiteSpeed) ---
  litespeed:
    image: ${LITESPEED_IMAGE:-litespeedtech/openlitespeed:1.8.5-lsphp85}
    container_name: litespeed
    restart: always
    stop_grace_period: 30s
    shm_size: '512mb'
    cpuset: "0,1"
    sysctls:
      - net.core.somaxconn=65535
      - net.ipv4.tcp_fastopen=3
    deploy:
      resources:
        reservations:
          memory: ${OLS_MEM_RESERVE:-2G} 
        limits:
          memory: ${OLS_MEM_LIMIT:-3500M}
    environment:
      TZ: ${TIMEZONE:-Pacific/Honolulu}
 
    volumes:
      - ./lsws/php/php.ini:/usr/local/lsws/${LSPHP_NAME:-lsphp85}/etc/php/${PHP_VERSION:-8.5}/litespeed/php.ini
      - ./lsws/admin-conf:/usr/local/lsws/admin/conf
      - ./bin/container:/usr/local/bin
      - ./sites:/var/www/vhosts/
      - ./acme:/root/.acme.sh/
      - ./logs:/usr/local/lsws/logs/
      - ./redis/run:/var/run/redis
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "7080:7080" 
    networks:
      - wp_network

  # --- 3. Database Management ---
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadminnao
    restart: "no"
    cpuset: "0,1"
    profiles:
      - manual
    environment:
      PMA_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      UPLOAD_LIMIT: 512M
      MAX_EXECUTION_TIME: 600
    ports:
      - "${PMA_PORT:-8080}:80"
    networks:
      - wp_network

  # --- 4. Cache (Redis Optimized) ---
  redis:
    image: ${REDIS_IMAGE:-redis:latest}
    container_name: redis
    restart: always
    cpuset: "0"
    sysctls: 
      - net.core.somaxconn=65535
    entrypoint: >
      sh -c "
      rm -f /var/run/redis/redis.sock && 
      exec redis-server 
      --port 6379 
      --unixsocket /var/run/redis/redis.sock 
      --unixsocketperm 777 
      --tcp-backlog 65535 
      --databases 64 
      --maxmemory ${REDIS_MAX_MEMORY:-128mb} 
      --maxmemory-policy allkeys-lru 
      --save '' 
      --appendonly no 
      --timeout 0
      --maxclients 20000
      --hz 100
      --activedefrag yes
      --lazyfree-lazy-eviction yes
      --lazyfree-lazy-expire yes
      --lazyfree-lazy-server-del yes
      "
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEM_LIMIT:-256M}
    volumes:
      - ./redis/data:/data
      - ./redis/run:/var/run/redis
    networks:
      - wp_network

networks:
  wp_network:
    driver: bridge