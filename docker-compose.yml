services:
  # --- 1. Database (MariaDB 11.x LTS) ---
  mysql:
    image: ${MARIADB_IMAGE:-mariadb:lts-noble}
    container_name: mariadb
    restart: always
    stop_grace_period: 1m
    logging:
      driver: none            # CRITICAL: Reduces I/O interrupts on 2-core VPS
    security_opt:
      - seccomp:unconfined    # Required for io_uring speed
    command:
      - "mariadbd"
      - "--thread-cache-size=${THREAD_CACHE_SIZE:-128}"
      - "--max-allowed-packet=${DB_MAX_PACKET:-512M}"
      - "--max-connections=${MARIADB_MAX_CONNS:-151}"
      - "--innodb-buffer-pool-size=${DB_BUFFER_POOL:-512M}"
      - "--innodb-log-file-size=${DB_LOG_FILE:-512M}"
      - "--innodb-flush-log-at-trx-commit=${DB_FLUSH_COMMIT:-2}"
      - "--innodb-adaptive-hash-index=1" # SPEEDS UP: Creates internal shortcuts for frequent joins
      - "--table-definition-cache=1400"
      - "--table-open-cache=2800"
      - "--innodb-read-io-threads=2"
      - "--innodb-write-io-threads=2"
      - "--innodb-io-capacity=2000"      # LOWERED: Prevents "Interrupt Storms"
      - "--innodb-io-capacity-max=4000"
      - "--performance-schema=0"
      - "--skip-name-resolve=1"
    deploy:
      resources:
        limits:
          memory: ${DB_MEM_LIMIT:-768M}
    volumes:
      - ./data/db:/var/lib/mysql:delegated
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    networks:
      - wp_network

  # --- 2. Web Server (OpenLiteSpeed) ---
  litespeed:
    image: ${LITESPEED_IMAGE:-litespeedtech/openlitespeed:1.8.5-lsphp85}
    container_name: litespeed
    restart: always
    stop_grace_period: 30s
    shm_size: '512mb'
    deploy:
      resources:
        reservations:
          memory: ${OLS_MEM_RESERVE:-2G} 
        limits:
          memory: ${OLS_MEM_LIMIT:-4000M}
    environment:
      TZ: ${TIMEZONE:-Pacific/Honolulu}
    volumes:
      - ./lsws/conf:/usr/local/lsws/conf
      - ./lsws/admin-conf:/usr/local/lsws/admin/conf
      - ./lsws/php/php.ini:/usr/local/lsws/${LSPHP_NAME:-lsphp85}/etc/php/${PHP_VERSION:-8.5}/litespeed/php.ini
      - ./bin/container:/usr/local/bin
      - ./sites:/var/www/vhosts/
      - ./acme:/root/.acme.sh/
      - ./logs:/usr/local/lsws/logs/
      - ./redis/run:/var/run/redis
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "7080:7080" 
    networks:
      - wp_network

# --- 3. Database Management ---
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadminnao
    restart: "no"
    profiles:
      - manual
    environment:
      PMA_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      UPLOAD_LIMIT: 512M
      MAX_EXECUTION_TIME: 600
    ports:
      - "8080:80"
    networks:
      - wp_network

  # --- 4. Cache (Redis Optimized) ---
  redis:
    image: ${REDIS_IMAGE:-redis:8.4.0}
    container_name: redis
    restart: always
    logging:
      driver: none            # Reduces overhead on the bridge
    command: >
      sh -c "
      rm -f /var/run/redis/redis.sock && 
      exec redis-server 
      --port 6379 
      --unixsocket /var/run/redis/redis.sock 
      --unixsocketperm 777 
      --maxmemory ${REDIS_MAX_MEMORY:-128mb} 
      --maxmemory-policy allkeys-lru 
      --save '' 
      --appendonly no
      "
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEM_LIMIT:-256M}
    volumes:
      - ./redis/data:/data
      - ./redis/run:/var/run/redis
    networks:
      - wp_network

networks:
  wp_network:
    driver: bridge