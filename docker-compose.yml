services:
  # --- 1. Database (MariaDB 11.x LTS) ---
  mysql:
    image: ${MARIADB_IMAGE:-mariadb:lts-noble}
    container_name: mariadb
    restart: always
    stop_grace_period: 1m
    cpuset: "0,1"
    command:
      - "mariadbd"
      - "--max-allowed-packet=512M"
      - "--max-connections=${MARIADB_MAX_CONNS:-151}"
      - "--innodb-buffer-pool-size=${DB_BUFFER_POOL:-512M}"
      - "--innodb-log-file-size=${DB_LOG_FILE:-128M}"
      - "--innodb-flush-log-at-trx-commit=${DB_FLUSH_COMMIT:-2}"
      - "--performance-schema=0"
    deploy:
      resources:
        limits:
          memory: ${DB_MEM_LIMIT:-1.2G}
    volumes:
      - ./data/db:/var/lib/mysql:delegated
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    networks:
      - wp_network

  # --- 2. Web Server (OpenLiteSpeed) ---
  litespeed:
    image: ${LITESPEED_IMAGE:-litespeedtech/openlitespeed:1.8.5-lsphp85}
    container_name: litespeed
    restart: always
    stop_grace_period: 30s
    shm_size: '256mb'
    cpuset: "0,1"
    deploy:
      resources:
        limits:
          memory: ${OLS_MEM_LIMIT:-3.8G}
    environment:
      TZ: ${TIMEZONE:-Pacific/Honolulu}
      LSAPI_CHILDREN: ${PHP_WORKERS:-24}
      PHP_LSAPI_CHILDREN: ${PHP_WORKERS:-24}
      LSAPI_AVOID_FORK: ${PHP_FORK_THRESHOLD:-100M}
      LSAPI_MAX_IDLE_CHILDREN: ${PHP_MAX_IDLE:-2}
      OLS_WORKERS: ${OLS_WORKERS:-1}
      CPU_AFFINITY: ${CPU_AFFINITY:-1}
    volumes:
      - ./lsws/conf:/usr/local/lsws/conf
      - ./lsws/admin-conf:/usr/local/lsws/admin/conf
      - ./bin/container:/usr/local/bin
      - ./sites:/var/www/vhosts/
      - ./acme:/root/.acme.sh/
      - ./logs:/usr/local/lsws/logs/
      - redis_socket:/var/run/redis
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
      - "7080:7080" 
    networks:
      - wp_network

  # --- 3. Database Management (phpMyAdmin) ---
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: phpmyadminnao
    restart: "no"
    cpuset: "0,1"
    profiles:
      - manual
    environment:
      PMA_HOST: mysql
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      UPLOAD_LIMIT: 512M
      MAX_EXECUTION_TIME: 600
    ports:
      - "${PMA_PORT:-8080}:80"
    networks:
      - wp_network

  # --- 4. Cache (Redis Socket) ---
  redis:
    image: ${REDIS_IMAGE:-redis:alpine}
    container_name: redis
    restart: always
    cpuset: "0"
    command: redis-server ${REDIS_COMMAND}
    deploy:
      resources:
        limits:
          memory: ${REDIS_MEM_LIMIT:-128M}
    volumes:
      - ./redis/data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf
    environment:
      - REDIS_REPLICATION_MODE=master
    restart: always
    networks:
      - default
networks:
  default:
    driver: bridge
